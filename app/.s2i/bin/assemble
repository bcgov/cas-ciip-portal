#!/bin/bash

set -e
shopt -s dotglob

echo "---> Installing application source ..."
mv /tmp/src/* ./

# restore build artifacts
if [[ -d /tmp/artifacts/ ]]; then
    echo "Restoring build artifacts"
    cp -rl /tmp/artifacts/. ./
fi

# Set the DEV_MODE to false by default.
if [ -z "$DEV_MODE" ]; then
  export DEV_MODE=false
fi

# If NODE_ENV is not set by the user, then NODE_ENV is determined by whether
# the container is run in development mode.
if [ -z "$NODE_ENV" ]; then
  if [ "$DEV_MODE" == true ]; then
    export NODE_ENV=development
  else
    export NODE_ENV=production
  fi
fi

echo "---> Installing all dependencies"
yarn install --frozen-lockfile --check-files --production=false

echo "---> Building"
yarn build:relay
yarn build:next
yarn build:storybook

yarn install --frozen-lockfile --check-files --production=true
yarn cache clean

# Fix apt-root directory permissions
fix-permissions ../
